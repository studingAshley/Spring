<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.java.mapper.PostMapper">
		

 	
	<insert id="sendPost"  >
		<selectKey resultType="int" keyProperty="post_id" order="AFTER">
			select post_seq.currval from dual
		</selectKey>
		insert into post (POST_ID, USER_ID,PCONTENT, PLOCATION,PGROUP, PSTEP, PINDENT, HIT,RENOTE, PLIKE, VIEWHIT0, VIEWHIT6,VIEWHIT12, VIEWHIT18, CREATED , UPDATED)
			values(
			POST_SEQ.nextval,
			#{user_id},
			#{pcontent},
			#{plocation},
			post_seq.currval,
			0,0,
			0,0,0,
			0,0,0,0,
			sysdate,
			sysdate
			)
	</insert>
	
	<insert id="sendModalPost"  >
		<selectKey resultType="int" keyProperty="post_id" order="AFTER">
			select post_seq.currval from dual
		</selectKey>
		insert into post (POST_ID, USER_ID,PCONTENT, PLOCATION,PGROUP, PSTEP, PINDENT, HIT,RENOTE, PLIKE, VIEWHIT0, VIEWHIT6,VIEWHIT12, VIEWHIT18, CREATED , UPDATED)
			values(
			POST_SEQ.nextval,
			#{user_id},
			#{pcontent},
			#{plocation},
			#{pgroup},
			#{pstep}+1,#{post_id},
			0,0,0,
			0,0,0,0,
			sysdate,
			sysdate
			)
	</insert>
	
	 <select id="getMyTimeline" resultType="com.java.dto.PostDto">
 		select * from(select ROW_NUMBER() OVER (ORDER BY pgroup desc, pstep asc,  created desc) rnum, 
 		ff.* from (select 
 		post.post_id, 
 		post.user_id, 
 		post.pcontent, 
 		post.plocation, 
 		post.pgroup, 
 		post.pstep, 
 		post.pindent, 
 		post.hit, 
 		post.viewhit0, 
 		post.viewhit6, 
 		post.viewhit12, 
 		post.viewhit18, 
 		post.created, 
 		post.updated, 
 		post.renote, 
 		post.plike from 
 		( select * from user_follow  where user_id=#{id})uf, 
 		post  where post.user_id = uf.target_id or post.user_id=#{id} 
 		GROUP BY 
 		post.post_id, 
 		post.user_id, 
 		post.pcontent, 
 		post.plocation, 
 		post.pgroup, 
 		post.pstep, 
 		post.pindent, 
 		post.hit, 
 		post.viewhit0, 
 		post.viewhit6, 
 		post.viewhit12, 
 		post.viewhit18, 
 		post.created, 
 		post.updated, 
 		post.renote, post.plike) ff) where rnum between 1 and 20

 	</select>
 	
 	<select id="getSelected" resultType="com.java.dto.PostDto">

 		select ROW_NUMBER() OVER (ORDER BY pgroup desc, pstep asc, created desc) rnum, a.* from  (select * from post where post_id = #{post_id} or pindent = #{post_id})a
 	</select>
 	
 	<select id="getSeletedHit" resultType="com.java.dto.PostDto">

 		select * from post where post_id=#{post_id}
 	
 	</select>
 	
 	
 	
 	 <select id="getMaxStep" resultType="com.java.dto.PostDto">
 		select MAX(pstep) from (select * from post where pgroup = #{post_id})
 	</select>
 	
 	<select id="getRenoteCounter" resultType="int">
 		select count(*) from renote where post_id = #{post_id}
 	</select>
 	
 	 <select id="getRenote" resultType="com.java.dto.RenoteDto">
 		select * from renote where post_id = #{post_id}
 	</select>
 	
 	 <select id="myRenoteCounter" resultType="int">
 		select count(*) from renote where user_id = #{user_id} and post_id= #{post_id}
 	</select>
 	
 	 <select id="getFavorCounter" resultType="int">
 		select count(*) from post_like where post_id = #{post_id}
 	</select>
 	
 	 <select id="getfavor" resultType="com.java.dto.RenoteDto">
 		select * from post_like where post_id = #{post_id}
 	</select>
 	
 	 <select id="myFavorCounter" resultType="int">
 		select count(*) from post_like where user_id = #{user_id} and post_id= #{post_id}
 	</select>
 	
 	 <select id="getReplyCounter" resultType="int">
 		select count(*) from post where pindent=#{post_id}
 	</select>
 	
 	 <select id="getReply" resultType="com.java.dto.RenoteDto">
 		select * from post where pindent=#{post_id}
 	</select>
 	

 	
 	
 	<update id="upStep">
 		update post set pstep=pstep+1 where pgroup=#{pgroup} and pstep>#{pstep}
 	</update>
 	
 	<update id="updateHit">
		UPDATE post  SET hit = hit+1 where post_id=${post_id}
	</update>
	
	
	
 	<update id="repeatOn">
		UPDATE post  SET renote = renote+1 where post_id=${post_id}
	</update>
	
	 <update id="repeatOff">
		UPDATE post  SET renote = renote-1 where post_id=${post_id}
	</update>
	
	 <update id="favoriteOn">
		UPDATE post  SET plike = plike+1 where post_id=${post_id}
	</update>
	
	 	<update id="favoriteOff">
		UPDATE post  SET plike = plike-1 where post_id=${post_id}
	</update>
	
	
	
 	
 	<delete id="deleteOne">
		delete from post where post_id=#{post_id}
	</delete>
	
	
	
</mapper>